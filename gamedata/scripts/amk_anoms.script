-- -*- mode: lua; coding: windows-1251-dos -*-
--[[-------------------------- variable and table --------------------------]]
local table_sort=table.sort
local math_random=math.random
local string_find=string.find

local anoms_classes = {
  [ clsid.zone_bfuzz_s   ] = true,
  [ clsid.zone_electra_s ] = true,
  [ clsid.zone_galant_s  ] = true,
  [ clsid.zone_ice_s     ] = true,
  [ clsid.zone_mbald_s   ] = true,
  [ clsid.zone_mincer_s  ] = true,
  [ clsid.zone_zharka_s  ] = true,
}

local anoms_difficulty_koef = {
  [ 0 ] = 0.75,
  [ 1 ] = 1.0,
  [ 2 ] = 1.25,
  [ 3 ] = 1.5,
}

local anoms_sections = {
  buzz      = {
    [ "zone"  ] = "buzz",
    [ "shape" ] = { shtype = 0, radius = 1.5, center = { 0, 0, 0 } },
  },
  electra   = {
    [ "zone"  ] = "witches_galantine",
    [ "shape" ] = { shtype = 0, radius = 4,   center = { 0, 0, 0 } },
  },
  fountain  = {
    [ "zone"  ] = "fountain",
    [ "shape" ] = { shtype = 0, radius = 2.5, center = { 0, 0, 0 } },
  },
  gravi     = {
    [ "zone"  ] = "gravi_zone",
    [ "shape" ] = { shtype = 0, radius = 3,   center = { 0, 0, 0 } },
  },
  mincer    = {
    [ "zone"  ] = "mincer",
    [ "shape" ] = { shtype = 0, radius = 3.5, center = { 0, 0, 0 } },
  },
  mosquito_bald = {
    [ "zone"  ] = "mosquito_bald",
    [ "shape" ] = { shtype = 0, radius = 3,   center = { 0, 0, 0 } },
  },
  radioactive = {
    [ "zone"  ] = "radioactive",
    [ "shape" ] = { shtype = 0, radius = 5,   center = { 0, 0, 0 } },
  },
  sakbuzz   = {
    [ "zone"  ] = "sakbuzz",
    [ "shape" ] = { shtype = 0, radius = 4,   center = { 0, 0, 0 } },
  },
  sakbuzz_nlc = {
    [ "zone"  ] = "sakbuzz_nlc",
    [ "shape" ] = { shtype = 0, radius = 3,   center = { 0, 0, 0 } },
  },
  smallrain = {
    [ "zone"  ] = "smallrain",
    [ "shape" ] = { shtype = 0, radius = 4,   center = { 0, 0, 0 } },
  },
  sphere    = {
    [ "zone"  ] = "sphere",
    [ "shape" ] = { shtype = 0, radius = 2.8, center = { 0, 0, 0 } },
  },
  zavesa    = {
    [ "zone"  ] = "zavesa",
    [ "shape" ] = { shtype = 0, radius = 3,   center = { 0, 0, 0 } },
  },
  zharka_static = {
    [ "zone"  ] = "zharka_static",
    [ "shape" ] = {
      shtype = 1,
      v1     = { 1, 0, 0 }, v2 ={ 0, 5, 0 }, v3 = { 0, 0, 1 },
      offset = { 0, 0, 0 },
    }
  },
}
local anti_spawn_zones = {}
local arts_sections = {
  [ "capsule" ] = {
    "af_capsule",
  },
  [ "modif_1" ] = {
    "af_armor_1",
    "af_babka_1",
    "af_cry_1",
    "af_dik_1",
    "af_kol_1",
    "af_pudd_1",
    "af_spirit_1",
  },
  [ "modif_2" ] = {
    "af_armor_2",
    "af_babka_2",
    "af_cry_2",
    "af_dik_2",
    "af_kol_2",
    "af_pudd_2",
    "af_spirit_2",
  },
  [ "modif_3" ] = {
    "af_armor_3",
    "af_babka_3",
    "af_dik_3",
    "af_kol_3",
    "af_pudd_3",
    "af_spirit_3",
  },
  [ "simple" ] = {
    "af_ameba_mica",
    "af_ameba_slime",
    "af_ameba_slug",
    "af_blood",
    "af_buliz",
    "af_cristall",
    "af_cristall_flower",
    "af_drops",
    "af_dummy_battery",
    "af_dummy_dummy",
    "af_dummy_glassbeads",
    "af_dummy_pellicle",
    "af_dummy_spring",
    "af_electra_flash",
    "af_electra_moonlight",
    "af_electra_sparkler",
    "af_eye_voron",
    "af_fireball",
    "af_fuzz_kolobok",
    "af_gold_fish",
    "af_gravi",
    "af_medusa",
    "af_mincer_meat",
    "af_night_star",
    "af_rusty_kristall",
    "af_rusty_sea-urchin",
    "af_rusty_thorn",
    "af_soul",
    "af_vyvert",
    "art_acumm",
  },
}

-- Здесь перечислены все интервалы game_vertex для каждого
-- уровня. Можно не запуская игру смотреть, на каком уровне спавнится
-- объект
game_vertexes = {
  l01_escape            = {    0, 251  },
  l02_garbage           = {  252, 415  },
  l03_agroprom          = {  416, 702  },
  l03u_agr_underground  = {  703, 810  },
  l04_darkvalley        = {  811, 1108 },
  l04u_labx18           = { 1109, 1167 },
  l05_bar               = { 1168, 1307 },
  l06_rostok            = { 1308, 1437 },
  l08_yantar            = { 1438, 1528 },
  l08u_brainlab         = { 1529, 1544 },
  l07_military          = { 1545, 1861 },
  l10_radar             = { 1862, 2116 },
  l11_pripyat           = { 2117, 2272 },
  l12_stancia           = { 2273, 2401 },
  l12u_sarcofag         = { 2402, 2466 },
  l12u_control_monolith = { 2467, 2516 },
  l12_stancia_2         = { 2517, 2660 },
  l10u_bunker           = { 2661, 2791 },
  atp_for_test22        = { 2792, 2861 },
  peshera               = { 2862, 2880 },
  puzir                 = { 2881, 2885 },
  aver                  = { 2886, 2908 },
  av_peshera            = { 2909, 2987 },
  limansk               = { 2988, 3027 },
  hospital              = { 3028, 3075 },
  generators            = { 3076, 3152 },
  warlab                = { 3153, 3223 },
  red_forest            = { 3224, 3323 },
  lost_village          = { 3324, 3336 },
  marsh                 = { 3337, 3581 },
  dead_city             = { 3582, 3659 },
  zaton                 = { 3660, 3699 },
  jupiter               = { 3700, 3747 },
  pripyat               = { 3748, 3770 },
  jupiter_underground   = { 3771, 3829 },
  labx8                 = { 3830, 3850 },
}

level_vertexes = {
  l01_escape            =  595499,
  l02_garbage           =  382663,
  l03_agroprom          =  437421,
  l03u_agr_underground  =    4932,
  l04_darkvalley        =  390125,
  l04u_labx18           =    7581,
  l05_bar               =   99539,
  l06_rostok            =   67713,
  l07_military          =  418268,
  l08_yantar            =  141471,
  l08u_brainlab         =    8008,
  l10_radar             =  227189,
  l10u_bunker           =    8821,
  l11_pripyat           =  261219,
  l12_stancia           =  477923,
  l12_stancia_2         =  264576,
  l12u_control_monolith =    3982,
  l12u_sarcofag         =   10672,
  puzir                 =  377572,
  aver                  = 1790762,
  marsh                 =  528961,
  limansk               =   61524,
  hospital              =    7865,
  red_forest            =  166431,
  lost_village          =   49127,
  generators            =  752337,
  atp_for_test22        = 1049687,
  dead_city             =  551769,
  zaton                 = 1851251,
  jupiter               = 1486320,
  pripyat               =  487255,
  av_peshera            =  172637,
  peshera               =   32341,
  warlab                =    7776,
  jupiter_underground   =   41001,
  labx8                 =    6781,
}

level_anoms = {
  l01_escape = {
    90, 120, 400,
    {
      buzz          =  0,
      electra       = 12,
      fountain      =  7,
      gravi         =  0,
      mincer        =  0,
      mosquito_bald =  0,
      sakbuzz       =  2,
      sakbuzz_nlc   =  5,
      smallrain     =  6,
      sphere        =  4,
      zavesa        =  2,
    }
  },
  l02_garbage = {
    90, 120, 400,
    {
      buzz          = 12,
      electra       = 15,
      fountain      =  2,
      gravi         = 10,
      mincer        =  2,
      mosquito_bald = 12,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 15,
      smallrain     =  5,
      sphere        =  3,
      zavesa        =  3,
    }
  },
  l03_agroprom = {
    90, 120, 100,
    {
      buzz          =  5,
      electra       =  0,
      fountain      =  2,
      gravi         = 10,
      mincer        =  3,
      mosquito_bald = 12,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 17,
      smallrain     =  4,
      sphere        =  3,
      zavesa        =  2,
    }
  },
  l04_darkvalley = {
    90, 120, 100,
    {
      buzz          = 10,
      electra       =  0,
      fountain      =  2,
      gravi         =  8,
      mincer        =  3,
      mosquito_bald = 12,
      radioactive   = 10,
      sakbuzz       =  5,
      sakbuzz_nlc   = 17,
      smallrain     =  5,
      sphere        =  4,
      zavesa        =  3,
      zharka_static =  8,
    }
  },
  l05_bar = {
    60, 80, 150,
    {
      buzz          =  5,
      electra       =  1,
      fountain      =  1,
      gravi         =  8,
      mincer        =  2,
      mosquito_bald =  8,
      sakbuzz       =  2,
      sakbuzz_nlc   =  5,
      smallrain     =  4,
      sphere        =  2,
      zavesa        =  3,
      zharka_static =  4,
    }
  },
  l06_rostok = {
    20, 30, 300,
    {
      buzz          = 10,
      electra       =  2,
      fountain      =  1,
      gravi         =  0,
      mincer        =  3,
      mosquito_bald =  7,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 25,
      smallrain     =  2,
      sphere        =  2,
      zavesa        =  2,
      zharka_static = 25,
    }
  },
  l08_yantar = {
    80, 120, 400,
    {
      buzz          =  8,
      electra       =  2,
      fountain      =  1,
      gravi         =  8,
      mincer        =  8,
      mosquito_bald =  8,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 15,
      smallrain     =  4,
      sphere        =  3,
      zavesa        =  3,
      zharka_static =  5,
    }
  },
  l07_military = {
    80, 120, 400,
    {
      buzz          = 10,
      electra       = 12,
      fountain      =  2,
      gravi         =  0,
      mincer        =  4,
      mosquito_bald = 15,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 20,
      smallrain     =  4,
      sphere        =  4,
      zavesa        =  3,
      zharka_static =  8,
    }
  },
  l10_radar = {
    90, 120, 100,
    {
      buzz          = 10,
      electra       =  2,
      fountain      = 10,
      gravi         = 10,
      mincer        =  6,
      mosquito_bald = 11,
      radioactive   = 15,
      sakbuzz       =  5,
      sakbuzz_nlc   = 20,
      smallrain     =  6,
      sphere        =  4,
      zavesa        =  3,
      zharka_static = 12,
    }
  },
  l11_pripyat = {
    90, 120, 90,
    {
      buzz          = 10,
      electra       = 10,
      fountain      =  1,
      gravi         = 10,
      mincer        = 10,
      mosquito_bald = 10,
      radioactive   =  6,
      sakbuzz       =  2,
      sakbuzz_nlc   = 10,
      smallrain     =  1,
      sphere        =  3,
      zavesa        =  3,
      zharka_static =  8,
    }
  },
  l12_stancia = {
    50, 90, 700,
    {
      buzz          = 10,
      electra       =  0,
      fountain      =  1,
      gravi         =  8,
      mincer        =  2,
      mosquito_bald = 10,
      radioactive   =  8,
      sakbuzz       =  4,
      sakbuzz_nlc   = 15,
      smallrain     =  6,
      sphere        =  4,
      zavesa        =  3,
      zharka_static =  7,
    }
  },
  puzir = {
    90, 120, 450,
    {
      buzz          = 12,
      electra       = 14,
      fountain      =  1,
      gravi         = 14,
      mincer        = 12,
      mosquito_bald = 15,
      radioactive   =  9,
      sakbuzz       =  3,
      sakbuzz_nlc   = 25,
      smallrain     =  6,
      sphere        =  4,
      zavesa        =  3,
      zharka_static =  5,
    }
  },
  aver = {
    150, 170, 450,
    {
      buzz          = 15,
      electra       =  0,
      fountain      =  1,
      gravi         = 15,
      mincer        = 14,
      mosquito_bald = 12,
      radioactive   = 12,
      sakbuzz       =  4,
      sakbuzz_nlc   = 25,
      smallrain     =  5,
      sphere        =  5,
      zavesa        =  4,
      zharka_static =  5,
    }
  },
  marsh = {
    120, 180, 100,
    {
      buzz          = 15,
      electra       =  0,
      fountain      =  1,
      gravi         = 15,
      mincer        =  8,
      mosquito_bald = 12,
      radioactive   = 12,
      sakbuzz       =  4,
      sakbuzz_nlc   = 25,
      smallrain     =  9,
      sphere        =  5,
      zavesa        =  4,
      zharka_static =  5,
    }
  },
  limansk = {
    15, 25, 30,
    {
      buzz          = 10,
      electra       =  0,
      fountain      = 16,
      gravi         = 10,
      mincer        = 12,
      mosquito_bald = 10,
      radioactive   =  6,
      sakbuzz       =  2,
      sakbuzz_nlc   = 15,
      smallrain     =  2,
      sphere        =  3,
      zavesa        =  2,
      zharka_static =  8,
    }
  },
  hospital = {
    5, 10, 100,
    {
      buzz          =  8,
      electra       =  7,
      fountain      =  1,
      gravi         =  5,
      mincer        =  8,
      mosquito_bald =  8,
      radioactive   =  6,
      sakbuzz       =  2,
      sakbuzz_nlc   = 15,
      sphere        =  2,
      zavesa        =  2,
      zharka_static =  5,
    }
  },
  red_forest = {
    90, 120, 40,
    {
      buzz          = 10,
      electra       =  3,
      fountain      =  2,
      gravi         = 10,
      mincer        =  8,
      mosquito_bald = 10,
      radioactive   =  8,
      sakbuzz       =  4,
      sakbuzz_nlc   = 25,
      smallrain     =  6,
      sphere        =  5,
      zavesa        =  4,
      zharka_static =  8,
    }
  },
  lost_village = {
    20, 30, 25,
    {
      buzz          =  5,
      electra       = 10,
      fountain      =  1,
      gravi         =  5,
      mincer        =  8,
      mosquito_bald =  8,
      radioactive   =  6,
      sakbuzz       =  2,
      sakbuzz_nlc   = 15,
      smallrain     =  1,
      sphere        =  3,
      zavesa        =  3,
      zharka_static =  5,
    }
  },
  generators = {
    150, 170, 450,
    {
      buzz          = 16,
      electra       = 15,
      fountain      =  1,
      gravi         = 10,
      mincer        = 15,
      mosquito_bald = 11,
      radioactive   = 12,
      sakbuzz       =  6,
      sakbuzz_nlc   = 25,
      smallrain     =  2,
      sphere        =  4,
      zavesa        =  5,
      zharka_static =  5,
    }
  },
  atp_for_test22 = {
    150, 170, 450,
    {
      buzz          = 20,
      electra       = 15,
      fountain      =  2,
      gravi         = 10,
      mincer        = 13,
      mosquito_bald = 10,
      radioactive   = 12,
      sakbuzz       =  4,
      sakbuzz_nlc   = 25,
      smallrain     =  2,
      sphere        =  4,
      zavesa        =  4,
      zharka_static = 10,
    }
  },
  dead_city = {
    130, 180, 90,
    {
      buzz          = 10,
      electra       = 10,
      fountain      =  2,
      gravi         = 10,
      mincer        = 10,
      mosquito_bald = 10,
      radioactive   =  9,
      sakbuzz       =  1,
      sakbuzz_nlc   = 25,
      smallrain     =  2,
      sphere        =  4,
      zavesa        =  3,
      zharka_static =  8,
    }
  },
  zaton = {
    225, 300, 450,
    {
      buzz          = 15,
      electra       = 25,
      fountain      =  5,
      gravi         = 15,
      mincer        = 15,
      mosquito_bald = 15,
      radioactive   = 16,
      sakbuzz       =  8,
      sakbuzz_nlc   = 25,
      smallrain     =  3,
      sphere        = 12,
      zavesa        =  6,
      zharka_static =  8,
    }
  },
  jupiter = {
    225, 300, 450,
    {
      buzz          = 25,
      electra       = 25,
      fountain      =  4,
      gravi         = 20,
      mincer        = 15,
      mosquito_bald = 20,
      radioactive   = 15,
      sakbuzz       =  5,
      sakbuzz_nlc   = 25,
      smallrain     =  3,
      sphere        = 12,
      zavesa        =  4,
    }
  },
  pripyat = {
    90, 120, 100,
    {
      buzz          = 15,
      electra       = 15,
      fountain      =  3,
      gravi         = 18,
      mincer        = 15,
      mosquito_bald = 18,
      radioactive   = 12,
      sakbuzz       =  4,
      sakbuzz_nlc   = 25,
      smallrain     =  1,
      sphere        = 10,
      zavesa        =  4,
    }
  },
}

local level_arts = {
  l01_escape = {
    2, 4,
    {
      [ "simple"  ] = 93,
      [ "modif_1" ] =  6,
      [ "capsule" ] =  1,
    }
  },
  l02_garbage = {
    2, 4,
    {
      [ "simple"  ] = 93,
      [ "modif_1" ] =  6,
      [ "capsule" ] =  1,
    }
  },
  l03_agroprom = {
    2, 4,
    {
      [ "simple"  ] = 88,
      [ "modif_1" ] =  6,
      [ "modif_2" ] =  5,
      [ "capsule" ] =  1,
    }
  },
  l04_darkvalley = {
    1, 2,
    {
      [ "simple"  ] = 93,
      [ "modif_1" ] =  6,
      [ "capsule" ] =  1,
    }
  },
  l05_bar = {
    0, 1,
    {
      [ "simple"  ] = 93,
      [ "modif_1" ] =  6,
      [ "capsule" ] =  1,
    }
  },
  l06_rostok = {
    1, 2,
    {
      [ "simple"  ] = 80,
      [ "modif_1" ] =  7,
      [ "modif_2" ] =  7,
      [ "modif_3" ] =  5,
      [ "capsule" ] =  1,
    }
  },
  l08_yantar = {
    1, 2,
    {
      [ "simple"  ] = 80,
      [ "modif_1" ] =  7,
      [ "modif_2" ] =  7,
      [ "modif_3" ] =  5,
      [ "capsule" ] =  1,
    }
  },
  l07_military = {
    1, 2,
    {
      [ "simple"  ] = 93,
      [ "modif_1" ] =  6,
      [ "capsule" ] =  1,
    }
  },
  l10_radar = {
    2, 4,
    {
      [ "simple"  ] = 76,
      [ "modif_2" ] =  8,
      [ "modif_3" ] =  8,
      [ "capsule" ] =  7,
      [ "modif_1" ] =  1,
    }
  },
  l11_pripyat = {
    2, 4,
    {
      [ "simple"  ] = 73,
      [ "modif_2" ] =  9,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  8,
      [ "modif_1" ] =  1,
    }
  },
  l12_stancia = {
    2, 4,
    {
      [ "simple"  ] = 68,
      [ "modif_2" ] = 16,
      [ "modif_3" ] =  8,
      [ "capsule" ] =  8,
    }
  },
  puzir = {
    2, 4,
    {
      [ "simple"  ] = 85,
      [ "modif_1" ] =  7,
      [ "modif_2" ] =  7,
      [ "capsule" ] =  1,
    }
  },
  aver = {
    2, 4,
    {
      [ "simple"  ] = 83,
      [ "modif_2" ] =  8,
      [ "modif_3" ] =  7,
      [ "capsule" ] =  2,
    }
  },
  marsh = {
    2, 6,
    {
      [ "simple"  ] = 82,
      [ "modif_2" ] =  9,
      [ "modif_3" ] =  7,
      [ "capsule" ] =  2,
    }
  },
  limansk = {
    2, 4,
    {
      [ "simple"  ] = 74,
      [ "modif_2" ] = 10,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  7,
    }
  },
  hospital = {
    1, 2,
    {
      [ "simple"  ] = 73,
      [ "modif_2" ] = 10,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  8,
    }
  },
  red_forest = {
    2, 4,
    {
      [ "simple"  ] = 74,
      [ "modif_2" ] =  9,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  8,
    }
  },
  lost_village = {
    0, 1,
    {
      [ "simple"  ] = 75,
      [ "modif_2" ] = 10,
      [ "modif_3" ] =  8,
      [ "capsule" ] =  7,
    }
  },
  generators = {
    2, 4,
    {
      [ "simple"  ] = 68,
      [ "modif_2" ] = 16,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  7,
    }
  },
  atp_for_test22 = {
    2, 4,
    {
      [ "simple"  ] = 81,
      [ "modif_1" ] =  7,
      [ "modif_2" ] =  7,
      [ "modif_3" ] =  5,
    }
  },
  dead_city = {
    2, 4,
    {
      [ "simple"  ] = 73,
      [ "modif_2" ] = 10,
      [ "modif_3" ] =  9,
      [ "capsule" ] =  8,
    }
  },
  zaton = {
    2, 4,
    {
      [ "simple"  ] = 76,
      [ "modif_2" ] =  8,
      [ "modif_3" ] =  8,
      [ "capsule" ] =  7,
      [ "modif_1" ] =  1,
    }
  },
  jupiter = {
    2, 4,
    {
      [ "simple"  ] = 76,
      [ "capsule" ] =  8,
      [ "modif_2" ] =  8,
      [ "modif_3" ] =  7,
      [ "modif_1" ] =  1,
    }
  },
  pripyat = {
    2, 4,
    {
      [ "simple"  ] = 76,
      [ "capsule" ] =  8,
      [ "modif_2" ] =  8,
      [ "modif_3" ] =  7,
      [ "modif_1" ] =  1,
    }
  },
}


--[[-------------------------- variable and table ---------------------end--]]
--[[-------------------------- function for spawn --------------------------]]


local forbidden_lvids, forbidden_pos

function init()
  local blow  = amk.load_variable( "blowout", 0 )
  local lname = level.name()
  if not level_vertexes[ lname ] then return end
  if not level_anoms[ lname ] then return end
  local anoms_sect = "amk_anoms." .. lname
  if sys_ini:section_exist( anoms_sect ) then
    for a = 0, sys_ini:line_count( anoms_sect ) - 1 do
      local result, id, value = sys_ini:r_line( anoms_sect, a, "", "" )
      if id and amk.trim( id ) ~= "" and amk.trim( id ) then
        local s = amk.str_explode( ",", id, true )
        if s[ 1 ] == nil or s[ 2 ] == nil or s[ 3 ] == nil or s[ 4 ] == nil then 
          abort( "amk_anoms:init() - error while parsing safe zones for " .. lname .. " at section's line #" .. ( a + 1 ) )
        end
        table.insert(
          anti_spawn_zones,
          {
            vector():set(
              tonumber( s[ 1 ] ),
              tonumber( s[ 2 ] ),
              tonumber( s[ 3 ] )
            ),
            tonumber( s[ 4 ] )
          }
        )
      end
    end
  end
  forbidden_pos = {}
  if blow > 0 and blow < 4 then return end
  -- Не менять аномалии в Госпитале, пока не сварен Камень Удачи и не оживлена
  -- Муха. Иначе удаляются те аномалии, которые нужны для этого дела и все,
  -- тупик.
  if
    lname == "hospital"
    and db.actor:has_info( "spawnim_3otsek" )
    and not db.actor:has_info( "spawn_hospit_live" )
  then
    return
  end
  pre_blow_off()
  randomize_arts()
  generate_anoms()
  generate_new_arts()
  forbidden_pos = {}
end


function generate_new_arts()
  if
    level_arts[ level.name() ]
    and not has_alife_info( "testsak_" .. level.name() )
  then
    generate_arts()
    db.actor:give_info_portion( "testsak_" .. level.name() )
  end
end


function after_blow_on()
  sak.off_testobj()
  local lname = level.name()
  forbidden_lvids = {
    [ db.actor:level_vertex_id() ] = true,
  }
  forbidden_pos   = { db.actor:position() }
  dsh_respawn.iterate_respawners(
    function( resp )
      local pos, lv, gv = unpack( resp.xyzlg )
      local lid = location_id_by_gvid( gv )
      if lid then
        local resp_lname = level_system_name_by_lid( lid )
        if resp_lname == lname then
          forbidden_lvids[ lv ] = true
          table.insert( forbidden_pos, pos )
        end
      end
    end
  )
  se_respawn.iterate_respawners(
    function( sobj )
      if object_level_name( sobj ) == lname then
        forbidden_lvids[ sobj.m_level_vertex_id ] = true
        table.insert( forbidden_pos, sobj.position )
      end
    end
  )
  for _, sobj in ipairs( get_all_mobs( lname ) ) do
    forbidden_lvids[ sobj.m_level_vertex_id ] = true
    table.insert( forbidden_pos, sobj.position )
  end
  if level_vertexes[ lname ] and level_anoms[ lname ] then
    generate_anoms()
    move_mgr.invalidate_pp_accessibility()
  end
  generate_new_arts()
  forbidden_pos = {}
end


function get_all_mobs( lname )
  local mobs = {}
  for id, sobj in pairs( se_stalker.stalkers ) do
    if
      ( not lname )
      or object_level_name( sobj ) == lname
    then
      table.insert( mobs, sobj )
    end
  end
  for id, sobj in pairs( se_monster.monsters ) do
    if
      ( not lname )
      or object_level_name( sobj ) == lname
    then
      table.insert( mobs, sobj )
    end
  end
  return mobs
end


function pre_blow_off()
  forbidden_lvids = {
    [ db.actor:level_vertex_id() ] = true,
  }
  forbidden_pos   = { db.actor:position() }
  dsh_respawn.iterate_respawners(
    function( resp )
      local pos, lv, gv = unpack( resp.xyzlg )
      local lid = location_id_by_gvid( gv )
      if lid then
        local resp_lname = level_system_name_by_lid( lid )
        if resp_lname == lname then
          forbidden_lvids[ lv ] = true
          table.insert( forbidden_pos, pos )
        end
      end
    end
  )
  se_respawn.iterate_respawners(
    function( sobj )
      if object_level_name( sobj ) == lname then
        forbidden_lvids[ sobj.m_level_vertex_id ] = true
        table.insert( forbidden_pos, sobj.position )
      end
    end
  )
  for id, sobj in pairs( se_zones.anoms ) do
    if is_generated_anomaly( sobj ) then
      alife():release( sobj, true )
    end
  end
  for _, sobj in ipairs( get_all_mobs( level.name() ) ) do
    forbidden_lvids[ sobj.m_level_vertex_id ] = true
    table.insert( forbidden_pos, sobj.position )
  end
end


function cleanup_arts()
  local known_arts  = {}
  local known_sects = {
    [ "af_buliz" ] = true,
  }
  for lname, alist in pairs( level_arts ) do
    if not known_arts[ lname ] then
      known_arts[ lname ] = {}
    end
    for k, v in pairs( alist[ 3 ] ) do
      local sect = arts_sections[ k ]
      if sect then
        for _, k in ipairs( sect ) do
          known_arts[ lname ][ k ] = true
          known_sects[ k ] = true
        end
      end
    end
  end
  for id = 1, 65534 do
    local sobj = alife():object( id )
    if sobj and sobj.parent_id == 65535 then
      local sect = sobj:section_name()
      local prop = amk_utils.get_item_props( sect )
      if prop.af_base then sect = prop.af_base end
      if known_sects[ sect ] then
        local lname = object_level_name( sobj )
        if
          sect == "af_buliz"
          or (
            known_arts[ lname ] and known_arts[ lname ][ sect ]
            and has_alife_info( "testsak_" .. lname )
            and not dsh.is_handmade_artefact( sobj )
          )
        then
          alife():release( sobj, true )
        end
      end
    end
  end
  for k, v in pairs( amk_offline_alife.off_npcs ) do
    v.artefacts = {}
  end
end


function generate_anoms()
  local lname = level.name()
  local v     = level_anoms[ lname ]
  if v then
    local cnt = 0
    local mxx = math.random( v[ 1 ], v[ 2 ] )
      * anoms_difficulty_koef[ level.get_game_difficulty() ]
    local pt  = profile_timer()
    pt:start()
    while cnt < mxx do
      local res = generate_anomaly()
      if res then
        cnt = cnt + 1
        add_anomaly( res.id, res.position, 5, res )
      elseif res == false then
        log2(
          "[%s]: I give up here: %s, %s / %s anomalies generated",
          script_name(), lname, cnt, mxx
        )
        break
      end
    end
    pt:stop()
    log2(
      "[%s]: %s anomalies generated, time spent = %s",
      script_name(), cnt, pt:time()
    )
  end
end


function generate_arts( need_cnt )
  local lname = level.name()
  if not level_vertexes[ lname ] then return end
  local v = level_arts[ lname ]
  if v then
    local cnt, mxx
    if need_cnt then
      cnt, mxx = 0, need_cnt
    else
      local min_cnt, max_cnt = v[ 1 ], v[ 2 ]
      local blowout_count    = ogse_surge_mgr.get_blowout_count()
      min_cnt = min_cnt - math.floor(
        blowout_count / ( 5 * ( 4 - level.get_game_difficulty() ) )
      )
      if min_cnt < 0 then min_cnt = 0 end
      cnt, mxx = 0, math.random( min_cnt, max_cnt )
    end
    while cnt < mxx do
      local res = generate_art( lname )
      if res then
        cnt = cnt + 1
      elseif res == false then
        log2(
          "[%s]: I give up here: %s, %s / %s artefacts generated",
          script_name(), lname, cnt, mxx
        )
        break
      end
    end
 end
end


function find_gvid( lname, pos )
  local gvn, gvx =
    game_vertexes[ lname ][ 1 ],
    game_vertexes[ lname ][ 2 ]
  local new_gv   = 0
  local min_dist = 100000
  for a = gvn, gvx do
    local tmp = game_graph():vertex( a ):level_point()
    if tmp:distance_to( pos ) < min_dist then
      min_dist = tmp:distance_to( pos )
      new_gv   = a
    end
  end
  if game_graph():valid_vertex_id( new_gv ) then
    return new_gv
  end
end


function calc_new_free_pos( lname, pre_check_coords_func )
  local lvx    = level_vertexes[ lname ]
  local new_lv = math.random( lvx )
  if forbidden_lvids[ new_lv ] then
    local found
    if new_lv < lvx then
      for i = new_lv + 1, lvx do
        if not forbidden_lvids[ i ] then
          found = i
          break
        end
      end
    end
    if not found and new_lv > 1 then
      for i = 1, new_lv - 1 do
        if not forbidden_lvids[ i ] then
          found = i
          break
        end
      end
    end
    if not found then
      log2(
        "[%s]: can't find any free level vertex for %s",
        script_name(), lname
      )
      return false
    end
    new_lv = found
  end
  forbidden_lvids[ new_lv ] = true
  local pos = level.vertex_position( new_lv )
  if
    check_coordinates( pos, lname )
    and (
      ( not pre_check_coords_func )
      or pre_check_coords_func( pos )
    )
  then
    local new_gv = find_gvid( lname, pos )
    if new_gv then
      return pos, new_gv, new_lv
    end
  end
end


function generate_anomaly()
  local pos, new_gv, new_lv = calc_new_free_pos( level.name() )
  if pos then
    table.insert( forbidden_pos, pos )
    return spawn_rand_anom( pos, new_gv, new_lv )
  elseif pos == false then
    return false
  end
end


function randomize_arts()
  local known_arts = {}
  for lname, alist in pairs( level_arts ) do
    if not known_arts[ lname ] then
      known_arts[ lname ] = {}
    end
    for k, v in pairs( alist[ 3 ] ) do
      local sect = arts_sections[ k ]
      if sect then
        for _, k in ipairs( sect ) do
          known_arts[ lname ][ k ] = true
        end
      end
    end
  end
  local is_relocating = true
  for id = 1, 65534 do
    local sobj = alife():object( id )
    if sobj and sobj.parent_id == 65535 then
      local sect  = sobj:section_name()
      local lname = object_level_name( sobj )
      if lname and lname == level.name() then
        local prop = amk_utils.get_item_props( sect )
        if prop.af_base then sect = prop.af_base end
        if
          known_arts[ lname ] and known_arts[ lname ][ sect ]
          and not dsh.is_handmade_artefact( sobj )
        then
          local orig_dist = sobj.position:distance_to( db.actor:position() )
          local cur_lv  = sobj.m_level_vertex_id
          local cur_pos = sobj.position
          if is_relocating then
            for i = 1, 100 do
              local pos, new_gv, new_lv = calc_new_free_pos(
                lname,
                function( np )
                  return (
                    np:distance_to( db.actor:position() ) >= orig_dist
                    and np:distance_to( sobj.position   ) >= 10
                  )
                end
              )
              if pos then
                alife():teleport_object( "", pos, new_lv, new_gv, sobj.id )
                cur_lv  = new_lv
                cur_pos = pos
                break
              elseif pos == false then
                log2(
                  "[%s]: stop relocation process here: %s, current art is %s",
                  script_name(), lname, sobj:name()
                )
                is_relocating = false
                break
              end
            end
          end
          forbidden_lvids[ cur_lv ] = true
          table.insert( forbidden_pos, cur_pos )
        elseif dsh.is_artefact( sobj:section_name() ) then
          forbidden_lvids[ sobj.m_level_vertex_id ] = true
          table.insert( forbidden_pos, sobj.position )
        end
      end
    end
  end
end


function generate_art( lname, section, pre_check_coords_func )
  local pos, new_gv, new_lv = calc_new_free_pos( lname, pre_check_coords_func )
  if pos then
    local sobj
    if section then
      local prop = amk_utils.get_item_props( section )
      if prop.has_af_dyn then
        section = make_dyn_art_sect( section )
        prop    = amk_utils.get_item_props( section )
      end
      if prop.af_bio_sect then section = prop.af_bio_sect end
      sobj = spawn_art( section, pos, new_gv, new_lv )
    else
      sobj = spawn_rand_arts( pos, new_gv, new_lv, lname )
    end
    table.insert( forbidden_pos, pos )
    return sobj
  end
end


function spawn_rand_anom( pos, gv, lv )
  local shapes, shape1 = {}, {}
  local section = "zone_ice"
  if math.random( 100 ) < 5 then
    shape1 = { shtype = 0, radius = 4, center = { 0, 0, 0 } }
  else
    section, shape1 = get_random_anomaly_sect( level.name() )
    ASSERT(
      section, "got nil from get_random_anomaly_sect( %s )", level.name()
    )
  end
  shapes[ 1 ] = {}
  shapes[ 1 ].shtype = shape1.shtype
  if shape1.shtype == 0 then
    shapes[ 1 ].radius = shape1.radius
    shapes[ 1 ].center = vector():set(
      shape1.center[ 1 ], shape1.center[ 2 ], shape1.center[ 3 ]
    )
  else
    shapes[ 1 ].v1     = vector():set(
      shape1.v1[ 1 ], shape1.v1[ 2 ], shape1.v1[ 3 ]
    )
    shapes[ 1 ].v2     = vector():set(
      shape1.v2[ 1 ], shape1.v2[ 2 ], shape1.v2[ 3 ]
    )
    shapes[ 1 ].v3     = vector():set(
      shape1.v3[ 1 ], shape1.v3[ 2 ], shape1.v3[ 3 ]
    )
    shapes[ 1 ].offset = vector():set(
      shape1.offset[ 1 ], shape1.offset[ 2 ], shape1.offset[ 3 ]
    )
  end
  return spawn_anomaly( section, pos, gv, lv, shapes, "on" )
end


function get_anom_params( sect )
  return anoms_sections[ sect ]
end


function get_random_anomaly_sect( lname )
  local rnd_max   = 0
  local anomalies = {}
  for k, w in pairs( level_anoms[ lname ][ 4 ] ) do
    rnd_max = rnd_max + w
    local t = {
      [ "sect"   ] = k,
      [ "weight" ] = w,
    }
    table.insert( anomalies, t )
  end
  table.sort(
    anomalies,
    function( a, b ) return a.weight > b.weight end
  )
  local rnd = math.random( 0, rnd_max )
  local params
  for _, v in ipairs( anomalies ) do
    rnd = rnd - v.weight
    if rnd <= 0 then
      params = get_anom_params( v.sect )
      local suffixes = { "_weak", "_average", "_strong" }
      local section  = "amk_zone_" .. params.zone
        .. suffixes[ math.random( table.getn( suffixes ) ) ]
      return section, params.shape
    end
  end
end


function get_random_art_sect( lname )
  if not level_arts[ lname ] then return end
  local rnd_max = 0
  local arts    = {}
  for k, w in pairs( level_arts[ lname ][ 3 ] ) do
    rnd_max = rnd_max + w
    local t = {
      [ "sect"   ] = k,
      [ "weight" ] = w,
    }
    table.insert( arts, t )
  end
  table.sort(
    arts,
    function( a, b ) return a.weight > b.weight end
  )
  local rnd = dsh.get_next_random(
    script_name() .. ".get_random_art_sect", 0, rnd_max
  )
  for _, v in ipairs( arts ) do
    rnd = rnd - v.weight
    if rnd <= 0 then
      local items = arts_sections[ v.sect ]
      if table.getn( items ) > 1 then
        local rnd = dsh.get_next_random(
          script_name() .. ".get_random_art_sect", table.getn( items )
        )
        return items[ rnd ]
      else
        return items[ 1   ]
      end
    end
  end
end


function spawn_rand_arts( pos, gv, lv, lname )
  local sect = get_random_art_sect( lname )
  local prop = amk_utils.get_item_props( sect )
  if prop.has_af_dyn then
    sect = make_dyn_art_sect( sect )
    prop = amk_utils.get_item_props( sect )
  end
  if prop.af_bio_sect then sect = prop.af_bio_sect end
  return spawn_art( sect, pos, gv, lv )
end


function spawn_anomaly( section, pos, gv, lv, shape, status )
  local sobj = amk.spawn_item( section, pos, gv, lv )
  if sobj then
    local tbl = amk.get_anomaly_data( sobj )
    tbl.shapes = shape
    tbl.custom = modify_anomaly_custom_data( tbl.custom, status )
    amk.set_anomaly_data( tbl, sobj )
  end
  return sobj
end


function modify_anomaly_custom_data( cd, status )
  cd = m_net_utils.parse_custom_data( cd )
  if not cd then cd = {} end
  if not cd.dyn_anom then cd.dyn_anom = {} end 
  cd.dyn_anom.status = status
  return m_net_utils.gen_custom_data( cd )
end


function spawn_art( section, pos, gv, lv )
  if section then
    return amk.spawn_item( section, pos, gv, lv )
  end
end


function is_generated_anomaly( sobj )
  if sobj.parent_id ~= 65535 then return false end
  local sect = sobj:section_name()
  return
    sect == "zone_ice"
    or string.find( sect, "amk_zone_", 1, true )
end


-- аномалии, которые не исчезнут при НИ, да и вообще
function check_exclusion( obj, map )
  if is_generated_anomaly( obj ) then return false end
  if not level_vertexes[ map ]   then return true  end
  if not level_anoms[ map ]      then return true  end
  local obj_name = obj:name()
  return
    get_bool(
      obj:section_name(), script_name() .. ".check_exclusion", false
    )
    or string.find( obj_name, "zone_tuman" )       -- Острова туман 
    or string.find( obj_name, "zat_", 1, true )
    or string.find( obj_name, "zone_ozero" )
    or string.find( obj_name, "zone_fly_island" )  -- Острова парение
    or string.find( obj_name, "_snp" )             -- Снайпер
    or string.find( obj_name, "anim_ph_" )         -- Аномальные объекты
    or string.find( obj_name, "propeller" )        -- Пропеллер
    or string.find( obj_name, "sky_anomaly" )      -- Sky_Anomaly
    -- перемещающаяся электра (Кордон)
    or string.find( obj_name, "esc_zone_witches" )
    -- электра на колесе обозрения (ЦП)
    or string.find( obj_name, "pri_zone_witches" )
    or string.find( obj_name, "zone_topolinypuh" ) -- пух (Радар)
    -- холодцы в шахте (Красный Лес)
    or string.find( obj_name, "red_zone_acidic" )
    -- торнадо в подвале (Лиманск)
    or string.find( obj_name, "podval_tornado_strong" )
    -- фонтан в фонтане (МГ)
    or string.find( obj_name, "dcity_fontan_fountain_average" )
    -- электры везде (Росток)
    or string.find( obj_name, "rostok_zone_witches" )
    -- жарки в тоннеле (Росток)
    or string.find( obj_name, "rostok_zone_zharka_static" )
    -- эпичная смерть псевдоплоти (Кордон)
    or string.find( obj_name, "tutorial" )
    or (
      -- почему именно там?
      string.find( obj_name, "_mincer" ) and map ~= "l11_pripyat"
    )
end


function check_anti_spawn_zones( pos )
  for k, v in ipairs( anti_spawn_zones ) do
    if pos:distance_to( v[ 1 ] ) <= v[ 2 ] then return false end
  end
  return true
end


function check_hideouts( pos, lname )
  if not lname then lname = level.name() end
  local hides = amk_hideouts.hide[ lname ]
  if hides then
    for i, o in ipairs( hides ) do
      if o.zone then
        for j, v in ipairs( o.zone ) do
          local tmp
          if v.p3 then
            tmp = amk.check_npc_in_box(
              pos,
              vector():set( unpack( v.p1 ) ),
              vector():set( unpack( v.p2 ) ),
              vector():set( unpack( v.p3 ) )
            )
          else
            tmp = amk.check_npc_in_box(
              pos,
              vector():set( unpack( v.p1 ) ),
              vector():set( unpack( v.p2 ) )
            )
          end
          if tmp == true then return false end
        end
      end
    end
  end
  return true
end


function check_coordinates( pos, lname )
  if not lname then lname = level.name() end
  if not check_anti_spawn_zones( pos ) then return false end
  for _, fp in ipairs( forbidden_pos ) do
    if pos:distance_to( fp ) <= 5 then return false end
  end
  if not check_hideouts( pos, lname ) then return false end
  for _, lc in ipairs( bind_lc.get_all_lc_objs() ) do
    local binder = lc:binded_object()
    if binder.geom then
      local dist = geom_helpers.distance_from_zone_boundary( binder.geom, pos )
      if dist >= 0 or math.abs( dist ) < 5 then
        return false
      end
    end
  end
  return true
end


function is_anomaly( class_id, sobj )
  if sobj and is_generated_anomaly( sobj ) then return true end
  return ( class_id and anoms_classes[ class_id ] == true )
end


function bind( obj )
  obj:bind_object( anom_binder( obj ) )
end


class "anom_binder" ( object_binder )
function anom_binder:__init( obj ) super( obj )
  self.sm = ogse_signals.get_mgr()
end


function anom_binder:net_spawn( sobj )
  if not object_binder.net_spawn( self, sobj ) then
    return false
  end
  local pk = get_netpk( sobj, 1 )
  ASSERT( ( pk and pk:isOk() ), "can't read netpacket of %s", sobj:name() )
  local data   = pk:get()
  local radius = data.shapes:getRadius()
  sobj.radius  = radius
  add_anomaly( sobj.id, sobj.position, radius, sobj )
  self.sm:call( "on_anomaly_spawn", self.object, self )
  return true
end


function anom_binder:net_destroy()
  remove_anomaly( self.object:id() )
  self.sm:call( "on_anomaly_net_destroy", self.object, self )
  object_binder.net_destroy( self )
end


function get_radius_for_section( section )
  return get_float( section, "effective_radius", 2 )
end


anom_list = {}
function add_anomaly( id, pos, radius, sobj )
  local lname = object_level_name( sobj )
  anom_list[ id ] = {
    pos      = pos,
    clsid    = sobj:clsid(),
    radius   = radius or 0,
    section  = sobj:section_name(),
    location = lname
  }
end


function remove_anomaly( id )
  anom_list[ id ] = nil
end


function get_nearest_anomaly( npc )
  return get_nearest_anomaly_for_pos( npc:position() )
end


function get_nearest_anomaly_for_pos( posn )
  local anomid, pos, radius, dist
  local mindist = 10000000
  for id, o in pairs( anom_list ) do
    dist = posn:distance_to( o.pos ) - o.radius
    if dist < mindist then
      mindist = dist
      anomid  = id
      pos     = o.pos
      radius  = o.radius
    end
  end
  return anomid, pos, radius, mindist
end


function get_anomaly_list( npc, radius )
  return get_anomaly_list_for_pos( npc:position(), radius )
end


function get_anomaly_list_for_pos( posn, radius )
  local ret = {}
  for id, o in pairs( anom_list ) do
    local sobj = alife():object( id )
    if sobj then
      local dist = posn:distance_to( o.pos ) - o.radius
      if dist < radius then
        table.insert(
          ret, { id = id, name = sobj:name(), pos = o.pos, radius = o.radius }
        )
      end
    end
  end
  return ret
end


function make_dyn_art_sect( sect, min, bio )
  if min and min > 1 then
    min = ( min == 2 and 4  )
      or  ( min == 3 and 10 )
      or  ( min == 4 and 17 ) or 21
  else
    min = 1
  end
  local suff
  local arts_dyn = dsh.get_next_random(
    script_name() .. ".make_dyn_art_sect", min, 21
  )
  if arts_dyn     >=  1 and arts_dyn <=  3 then
    suff = "_dyn1d"
  elseif arts_dyn >=  4 and arts_dyn <=  9 then
    suff = "_dyn2d"
  elseif arts_dyn >= 10 and arts_dyn <= 16 then
    suff = "_dyn3d"
  elseif arts_dyn >= 17 and arts_dyn <= 20 then
    suff = "_dyn4d"
  else
    suff = "_dyn5d"
  end
  sect = sect .. suff
  if bio then
    local prop = amk_utils.get_item_props( sect )
    if prop.af_bio_sect then sect = prop.af_bio_sect end
  end
  return sect
end
